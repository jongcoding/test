---
- name: Install k3s and deploy Flask app on GCE
  hosts: k3s_nodes
  become: true
  gather_facts: true

  vars:
    app_name: "{{ lookup('env', 'APP_NAME') | default('flask-app', true) }}"
    namespace: "{{ lookup('env', 'K8S_NAMESPACE') | default('flask-app', true) }}"
    image_ref_env: "{{ lookup('env', 'IMAGE_REF') | default('', true) | trim }}"
    dockerhub_username: "{{ lookup('env', 'DOCKERHUB_USERNAME') | default('', true) | trim }}"
    image_ref_fallback: "{{ (dockerhub_username ~ '/' ~ app_name ~ ':latest') if (dockerhub_username | length > 0) else (app_name ~ ':latest') }}"
    image_ref: "{{ image_ref_env if (image_ref_env | length > 0) else image_ref_fallback }}"
    replicas: "{{ lookup('env', 'REPLICAS') | default('2', true) | int }}"
    service_type: "{{ lookup('env', 'SERVICE_TYPE') | default('NodePort', true) }}"
    node_port: "{{ lookup('env', 'K3S_NODE_PORT') | default('30080', true) | int }}"
    container_port: 5000
    k3s_install_exec: "--write-kubeconfig-mode 644 --disable traefik"

  pre_tasks:
    - name: Show selected image reference
      ansible.builtin.debug:
        msg:
          - "image_ref={{ image_ref }}"
          - "source={{ 'IMAGE_REF' if (image_ref_env | length > 0) else 'fallback(latest)' }}"

    - name: Ensure node port range is valid
      ansible.builtin.assert:
        that:
          - node_port >= 30000
          - node_port <= 32767
        fail_msg: "K3S_NODE_PORT는 30000-32767 범위여야 합니다."

  tasks:
    - name: Install required packages
      ansible.builtin.apt:
        name:
          - curl
          - ca-certificates
        state: present
        update_cache: true

    - name: Install k3s if missing
      ansible.builtin.shell: |
        set -euo pipefail
        if ! command -v k3s >/dev/null 2>&1; then
          curl -sfL https://get.k3s.io | INSTALL_K3S_EXEC="{{ k3s_install_exec }}" sh -
        fi
      args:
        executable: /bin/bash

    - name: Ensure k3s service is enabled and running
      ansible.builtin.systemd:
        name: k3s
        state: started
        enabled: true

    - name: Ensure kubeconfig is readable
      ansible.builtin.file:
        path: /etc/rancher/k3s/k3s.yaml
        mode: "0644"

    - name: Ensure kubectl symlink exists
      ansible.builtin.file:
        src: /usr/local/bin/k3s
        dest: /usr/local/bin/kubectl
        state: link
        force: true

    - name: Render Kubernetes manifest on remote host
      ansible.builtin.template:
        src: ../manifests/k3s-app.yaml.j2
        dest: /tmp/{{ app_name }}.yaml
        mode: "0644"

    - name: Apply manifest
      ansible.builtin.command: kubectl apply -f /tmp/{{ app_name }}.yaml

    - name: Wait for deployment rollout
      ansible.builtin.command: kubectl -n {{ namespace }} rollout status deployment/{{ app_name }} --timeout=240s

    - name: Show deployment and service status
      ansible.builtin.command: kubectl -n {{ namespace }} get deployment,service -o wide
      register: workload_status
      changed_when: false

    - name: Print status
      ansible.builtin.debug:
        var: workload_status.stdout_lines

    - name: Show access hint
      ansible.builtin.debug:
        msg:
          - "Access URL: http://{{ inventory_hostname }}:{{ node_port }}"
          - "If 외부에서 접근 시, GCE firewall에서 nodePort(기본 30080) 허용 필요"
